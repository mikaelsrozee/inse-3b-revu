<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>backend/manager/search.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="manager.account.html">account</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#./loggedIn">/loggedIn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#./login">/login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#./register">/register</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#./setEmail">/setEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#./verify/:token">/verify/:token</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.account.html#.getUser">getUser</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="manager.degree.html">degree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.degree.html#./degree/:degreeId">/degree/:degreeId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.degree.html#./degree/degreeNames">/degree/degreeNames</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="manager.review.html">review</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./:id">/:id</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./create">/create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./degree/:ID">/degree/:ID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./university/:ID">/university/:ID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./update">/update</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#./user/:ID">/user/:ID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#.createReview">createReview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#.getDegreeReviews">getDegreeReviews</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#.getUniversityReviews">getUniversityReviews</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#.getUserReviews">getUserReviews</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.review.html#.validateReview">validateReview</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="manager.search.html">search</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.search.html#./">/</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.search.html#.cacheSearchTerm">cacheSearchTerm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.search.html#.checkCacheForSearchTerm">checkCacheForSearchTerm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.search.html#.getCacheId">getCacheId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.search.html#.getSearchResults">getSearchResults</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="manager.uni.html">uni</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.uni.html#./uni/:uniId">/uni/:uniId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="manager.uni.html#./uni/uniNames">/uni/uniNames</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#/details">/details</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#/searches">/searches</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkAndRedirect">checkAndRedirect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateDropdown">populateDropdown</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">backend/manager/search.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace manager.search
 * @description Manager that holds api endpoints and functions for searching
 */


const express = require('express'),
	HTTP = require('http-status-codes'),
	db = require('../database/db.js'),
	cookieParser = require('cookie-parser'),
	AuthValidation = require('../middleware/auth.validation');

const router = new express.Router();
router.use(cookieParser());

const cache = {}; // Const as the pointer to the object will never change


/**
 * @memberOf manager.search
 * @func getCacheId
 * @desc Gets an ID that is unique to that search
 * @param query the query to be added to the cache
 * @param query.text {String} The text the user would like to search for
 * @param query.type {String} "all", "uni" or "degree"; Filter for the type to be returned
 * @param query.ucas {Number} The UCAS points required; 0 &lt;= ucas &lt;= 200
 * @param query.category {String} The category of university; Options stated in requirements doc
 * @param query.level {String} The level of study; “All”, “foundation”, “undergraduate”, “postgraduate”
 * @param query.studyType {String} The type of study time; “all”, “part”, “full”
 * @param query.sandwich {String} Whether the course is a sandwich; yes, no, any
 *
 * @return Promise&lt;String>
 */
function getCacheId(query) {
	return query.text + query.type +
		query.ucas + query.category +
		query.level + query.studyType +
		query.sandwich + query.pageNo;
}


/**
 * @memberOf manager.search
 * @func cacheSearchTerm
 * @desc Adds a search term to the cache
 * @param query the query to be added to the cache
 * @param query.text {String} The text the user would like to search for
 * @param query.type {String} "all", "uni" or "degree"; Filter for the type to be returned
 * @param query.ucas {Number} The UCAS points required; 0 &lt;= ucas &lt;= 200; Ucas of 0 is ignored
 * @param query.category {String} The category of university; "all", "business_law", "creative_cultural", "Humanities_Social_Sciences", "technology"
 * @param query.level {String} The level of study; “all”, “foundation”, “undergraduate”, “postgraduate”
 * @param query.studyType {String} The type of study time; “all”, “part”, “full”
 * @param query.sandwich {String} Whether the course is a sandwich; yes, no, all
 * @param results {Array} Array of results
 */
function cacheSearchTerm(query, results) {
	const id = getCacheId(query);
	cache[id] = results;
}


/**
 * @memberOf manager.search
 * @func checkCacheForSearchTerm
 * @desc Checks the cache for a search term
 * @param query the query to be added to the cache
 * @param query.text {String} The text the user would like to search for
 * @param query.type {String} "all", "uni" or "degree"; Filter for the type to be returned
 * @param query.ucas {Number} The UCAS points required; 0 &lt;= ucas &lt;= 200; Ucas of 0 is ignored
 * @param query.category {String} The category of university; "all", "business_law", "creative_cultural", "Humanities_Social_Sciences", "technology"
 * @param query.level {String} The level of study; “all”, “foundation”, “undergraduate”, “postgraduate”
 * @param query.studyType {String} The type of study time; “all”, “part”, “full”
 * @param query.sandwich {String} Whether the course is a sandwich; yes, no, all
 * @return {Object} searchResults object
 */
async function checkCacheForSearchTerm(query) {
	return new Promise(async (resolve, reject) => {
		const id = getCacheId(query);

		const results = cache[id];
		if (results !== undefined) {
			resolve(results);
		} else {
			reject();
		}
	});
}


/**
 * @memberOf manager.search
 * @func getSearchResults
 * @desc Searches the database for degrees and unis
 * @param query the query to be added to the cache
 * @param query.text {String} The text the user would like to search for
 * @param query.type {String} "all", "uni" or "degree"; Filter for the type to be returned
 * @param query.ucas {Number} The UCAS points required; 0 &lt;= ucas &lt;= 200; Ucas of 0 is ignored
 * @param query.category {String} The category of university; "all", "business_law", "creative_cultural", "Humanities_Social_Sciences", "technology"
 * @param query.level {String} The level of study; “all”, “foundation”, “undergraduate”, “postgraduate”
 * @param query.studyType {String} The type of study time; “all”, “part”, “full”
 * @param query.sandwich {String} Whether the course is a sandwich; yes, no, all
 * @return {Object} searchResults object
 */
async function getSearchResults(query) {
	const {text, type, ucas, category, level, studyType, sandwich} = query;

	let result = {totalCount: 0, count: 0, rows: []};

	let results = [];


	if (type !== 'degree') {

		let uniRes = await db.query(`select * from university where uni_name ILIKE $1 order by university.uni_name`, [`%${text}%`]);

		results = uniRes.rows;
	}


	if (type !== 'uni') {
		let dbQuery = ``;
		let params = [];
		let paramNumber = 1;

		dbQuery += `select u.uni_name, u.uni_id, d.degree_id, d.degree_name, ud.requirements_ucas, ud.requirements_grades, ` +
			`ud.degree_category, ud.degree_level, ud.degree_type, ud.degree_sandwich ` +
			`from uni_degree as ud ` +
			`inner join university as u on ud.uni_id = u.uni_id ` +
			`inner join degree as d on ud.degree_id = d.degree_id `;

		dbQuery += `where d.degree_name ILIKE $${paramNumber++} `;
		params.push(`%${text}%`);

		if (ucas !== 0 &amp;&amp; ucas !== "0") {
			dbQuery += `AND ud.requirements_ucas &lt;= $${paramNumber++} `;
			params.push(ucas);
		}

		if (category !== 'all') {
			dbQuery += `AND ud.degree_category = $${paramNumber++} `;
			params.push(category);
		}

		if (level !== 'all') {
			dbQuery += `AND ud.degree_level = $${paramNumber++} `;
			params.push(level);
		}

		if (studyType !== 'all') {
			dbQuery += `AND ud.degree_type = $${paramNumber++} `;
			params.push(studyType);
		}

		if (sandwich !== 'all') {
			dbQuery += `AND ud.degree_sandwich = $${paramNumber++} `;
			params.push(sandwich === 'yes');
		}


		dbQuery += `order by d.degree_name`;

		let uniDbRes = await db.query(dbQuery, params);

		results = results.concat(uniDbRes.rows);
	}


	return results;
}


/**
 * @memberOf manager.search
 * @func /
 * @desc Search based on the query, returns list of items
 * @param {Object} req express request object
 * @param req.query the query to be added to the cache
 * @param req.query.text {String} The text the user would like to search for
 * @param req.query.type {String} "all", "uni" or "degree"; Filter for the type to be returned
 * @param req.query.ucas {Number} The UCAS points required; 0 &lt;= ucas &lt;= 200; Ucas of 0 is ignored
 * @param req.query.category {String} The category of university; "all", "business_law", "creative_cultural", "Humanities_Social_Sciences", "technology"
 * @param req.query.level {String} The level of study; “all”, “foundation”, “undergraduate”, “postgraduate”
 * @param req.query.studyType {String} The type of study time; “all”, “part”, “full”
 * @param req.query.sandwich {String} Whether the course is a sandwich; yes, no, all
 * @param {Object} res express response object
 */
router.get('/', [AuthValidation.validSessionOptional, async (req, res) => {
	const query = req.query;
	const {text, type, ucas, category, level, studyType, sandwich,} = query;

	if (text === undefined || !(type &amp;&amp; ucas &amp;&amp; category &amp;&amp; level &amp;&amp; studyType &amp;&amp; sandwich)) {
		return res.status(HTTP.BAD_REQUEST).send('Must have all required query fields');
	}

	if (text === "") {
		return res.send([]);
	}

	if (ucas > 200 || ucas &lt; 0) {
		return res.status(HTTP.BAD_REQUEST).send(`ucas must be between 0 and 200 not ${ucas}`);
	}

	checkCacheForSearchTerm(query).then(results => {
		res.send(results);
	}).catch(async () => {
		const results = await getSearchResults(query);

		res.send(results);
		cacheSearchTerm(query, results);
		if (req.account &amp;&amp; req.account.user_id) {
			db.query('INSERT INTO user_searches (user_id, text, time) VALUES ($1, $2, now())', [req.account.user_id, query.text]);
		}
	});
}]);


module.exports = {
	router
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Sat Dec 12 2020 08:33:06 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
